{% load custom_filters %} <!-- โหลด custom filters -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const now = new Date();

            const endPicker = flatpickr("#booking_end", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                locale: "th",
                minDate: now
            });

            const startPicker = flatpickr("#booking_start", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                locale: "th",
                minDate: now,
                onChange: function (selectedDates) {
                    if (selectedDates.length > 0) {
                        const startDate = selectedDates[0];
                        const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                        endPicker.setDate(endDate);

                        const selectedDate = startDate.toISOString().split("T")[0];
                        fetch(`/booking/{{ table_name }}/?date=${selectedDate}`)
                            .then(response => response.json())
                            .then(data => {
                                const existingBookings = document.getElementById("existingBookings");
                                if (data.bookings && data.bookings.length > 0) {
                                    existingBookings.innerHTML = `<h3 class="text-lg font-bold mb-2">เวลาที่จองแล้ว:</h3>` +
                                        data.bookings.map(
                                            booking => `<div class="mb-1">เวลา: ${booking.start_time} - ${booking.end_time}</div>`
                                        ).join("");
                                } else {
                                    existingBookings.innerHTML = `<h3 class="text-lg font-bold mb-2">ไม่มีการจองสำหรับวันนี้</h3>`;
                                }
                            })
                            .catch(error => console.error("Error:", error));
                    }
                }
            });
        });

        function submitBooking() {
            const bookingStart = document.getElementById('booking_start').value;
            const bookingEnd = document.getElementById('booking_end').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            if (!bookingStart || !bookingEnd) {
                alert("กรุณาเลือกเวลาเริ่มต้นและเวลาสิ้นสุด");
                return;
            }

            fetch(window.location.href, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    booking_start: bookingStart,
                    booking_end: bookingEnd
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = "/success/";
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("เกิดข้อผิดพลาดในการจอง กรุณาลองใหม่อีกครั้ง");
                });
        }
    </script>
</head>

<body class="bg-gray-100">
    <div class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded shadow-lg">
        <h1 class="text-2xl font-bold mb-6">จองโต๊ะ: {{ table_name }}</h1>
        <p class="text-lg mb-4 text-gray-700">จำนวนที่นั่ง: {{ seating_capacity }} คน</p> <!-- แสดงจำนวนที่นั่ง -->

        <form id="bookingForm">
            {% csrf_token %}
            <div class="mb-4">
                <label for="booking_start" class="block text-sm font-medium text-gray-700">เวลาเริ่มต้น</label>
                <input type="text" id="booking_start" name="booking_start"
                    class="mt-1 block w-full border-gray-300 rounded-md" placeholder="เลือกเวลาเริ่มต้น">
            </div>
            <div class="mb-4">
                <label for="booking_end" class="block text-sm font-medium text-gray-700">เวลาสิ้นสุด</label>
                <input type="text" id="booking_end" name="booking_end"
                    class="mt-1 block w-full border-gray-300 rounded-md" placeholder="เวลาสิ้นสุดจะถูกกำหนดอัตโนมัติ">
            </div>
            <button type="button" onclick="submitBooking()"
                class="bg-blue-500 text-white px-4 py-2 rounded">ยืนยัน</button>
        </form>
        <div id="existingBookings" class="mt-4 text-gray-700"></div>
    </div>
</body>

</html>
